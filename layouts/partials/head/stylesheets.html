<!-- Styles -->
{{ $defaultTheme := .Param "defaultTheme" | default "light" }}

{{/* Critical CSS */}}
{{ $critical := sort (resources.Match "css/critical/*.css") "Name"
  | resources.Concat "css/critical.css"
  | resources.ExecuteAsTemplate "css/critical.css" .
  | css.PostCSS
}}

{{/* Non-critical CSS */}}
{{ $nonCritical := sort (resources.Match "css/non-critical/*.css") "Name"
  | resources.Concat "css/non-critical.css"
  | resources.ExecuteAsTemplate "css/non-critical.css" .
  | css.PostCSS
}}

{{/* Prism themes */}}
{{ $prismDark := resources.Get "prism-themes/prism-gruvbox-dark.css" }}
{{ $prismLight := resources.Get "prism-themes/prism-gruvbox-light.css" }}

{{/* Production processing */}}
{{ if hugo.IsProduction }}
  {{ $critical = $critical | resources.PostProcess }}
  {{ $nonCritical = $nonCritical | resources.PostProcess | fingerprint "sha512" }}
  {{ $prismDark = $prismDark | resources.PostProcess | fingerprint "sha512" }}
  {{ $prismLight = $prismLight | resources.PostProcess | fingerprint "sha512" }}
{{ end }}

<style>
  {{ $critical.Content | safeCSS }}
</style>

<link
  rel="preload"
  href="{{ $nonCritical.RelPermalink }}"
  as="style"
  onload="this.onload=null;this.rel='stylesheet'"
  {{ if hugo.IsProduction }}integrity="{{ $nonCritical.Data.Integrity }}"{{ end }}
/>

<link
  id="prism-dark"
  rel="preload"
  href="{{ $prismDark.RelPermalink }}"
  as="style"
  onload="this.onload=null;this.rel='stylesheet'"
  {{ if hugo.IsProduction }}integrity="{{ $prismDark.Data.Integrity }}"{{ end }}
  {{ if eq $defaultTheme "light" }}disabled{{ end }}
/>

<link
  id="prism-light"
  rel="preload"
  href="{{ $prismLight.RelPermalink }}"
  as="style"
  onload="this.onload=null;this.rel='stylesheet'"
  {{ if hugo.IsProduction }}integrity="{{ $prismLight.Data.Integrity }}"{{ end }}
  {{ if eq $defaultTheme "dark" }}disabled{{ end }}
/>

<noscript>
  {{ if eq $defaultTheme "light" }}
    <link
      rel="stylesheet"
      href="{{ $prismLight.RelPermalink }}"
      {{ if hugo.IsProduction }}integrity="{{ $prismLight.Data.Integrity }}"{{ end }}
    />
  {{ else }}
    <link
      rel="stylesheet"
      href="{{ $prismDark.RelPermalink }}"
      {{ if hugo.IsProduction }}integrity="{{ $prismDark.Data.Integrity }}"{{ end }}
    />
  {{ end }}

  <link
    rel="stylesheet"
    href="{{ $nonCritical.RelPermalink }}"
    {{ if hugo.IsProduction }}integrity="{{ $nonCritical.Data.Integrity }}"{{ end }}
  />
</noscript>
