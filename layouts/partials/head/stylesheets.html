{{ $defaultTheme := .Param "defaultTheme" | default "light" }}

{{/* ---------- Critical CSS ---------- */}}
{{ $critical := resources.Match "css/critical/*.css" }}
{{ with $critical }}
  {{ $criticalCSS := sort . "Name"
    | resources.Concat "css/critical.css"
    | resources.ExecuteAsTemplate "css/critical.css" .
    | css.PostCSS
  }}
  <style>{{ $criticalCSS.Content | safeCSS }}</style>
{{ end }}

{{/* ---------- Non-critical CSS ---------- */}}
{{ $nonCritical := resources.Match "css/non-critical/*.css" }}
{{ with $nonCritical }}
  {{ $nonCriticalCSS := sort . "Name"
    | resources.Concat "css/non-critical.css"
    | resources.ExecuteAsTemplate "css/non-critical.css" .
    | css.PostCSS
  }}

  {{ if hugo.IsProduction }}
    {{ $nonCriticalCSS = $nonCriticalCSS | fingerprint "sha512" | resources.PostProcess }}
  {{ end }}

  <link
    rel="preload"
    href="{{ $nonCriticalCSS.RelPermalink }}"
    as="style"
    onload="this.onload=null;this.rel='stylesheet'"
    {{ if hugo.IsProduction }}integrity="{{ $nonCriticalCSS.Data.Integrity }}"{{ end }}
  />

  <noscript>
    <link
      rel="stylesheet"
      href="{{ $nonCriticalCSS.RelPermalink }}"
      {{ if hugo.IsProduction }}integrity="{{ $nonCriticalCSS.Data.Integrity }}"{{ end }}
    />
  </noscript>
{{ end }}

{{/* ---------- Prism themes ---------- */}}
{{ with resources.Get "prism-themes/prism-gruvbox-dark.css" }}
  {{ $dark := . }}
  {{ if hugo.IsProduction }}
    {{ $dark = $dark | fingerprint "sha512" | resources.PostProcess }}
  {{ end }}
  <link
    id="prism-dark"
    rel="stylesheet"
    href="{{ $dark.RelPermalink }}"
    {{ if hugo.IsProduction }}integrity="{{ $dark.Data.Integrity }}"{{ end }}
    {{ if eq $defaultTheme "light" }}disabled{{ end }}
  />
{{ end }}

{{ with resources.Get "prism-themes/prism-gruvbox-light.css" }}
  {{ $light := . }}
  {{ if hugo.IsProduction }}
    {{ $light = $light | fingerprint "sha512" | resources.PostProcess }}
  {{ end }}
  <link
    id="prism-light"
    rel="stylesheet"
    href="{{ $light.RelPermalink }}"
    {{ if hugo.IsProduction }}integrity="{{ $light.Data.Integrity }}"{{ end }}
    {{ if eq $defaultTheme "dark" }}disabled{{ end }}
  />
{{ end }}
